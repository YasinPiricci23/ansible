- name: kubeadm init
  hosts: master
  become: yes
  tasks:

    - name: kubeadm init
      #command: kubeadm init --pod-network-cidr 10.244.0.0/16 --apiserver-advertise-address master_ip --control-plane-endpoint master_ip:6443 --upload-certs
      command: kubeadm init --pod-network-cidr 10.244.0.0/16 --apiserver-advertise-address 10.0.61.1 --control-plane-endpoint 10.0.61.1:6443 --upload-certs

    - name: kubeconfig
      shell: |
        mkdir -p $HOME/.kube
        sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
        sudo chown $(id -u):$(id -g) $HOME/.kube/config

    - name: weawe daemonset kurulumu
      command: kubectl apply -f https://github.com/weaveworks/weave/releases/download/v2.8.1/weave-daemonset-k8s.yaml


- name: kubeadm join nodes
  hosts: master
  become: yes
  tasks:
    - name: Get the token for joining the worker nodes
      become: yes
      shell: kubeadm token create  --print-join-command
      register: kubernetes_join_command


    - name: Copy join command to local file.
      become: yes
      local_action: copy content="{{ kubernetes_join_command.stdout_lines[0] }}" dest="/tmp/kubernetes_join_command"



- name: Get the token for joining the worker nodes
  hosts: worker
  become: yes
  gather_facts: yes

  tasks:
    - name: Copy join command from Ansiblehost to the worker nodes.
      become: yes
      copy:
        src: /tmp/kubernetes_join_command
        dest: /tmp/kubernetes_join_command
        mode: 0777

    - name: Join the Worker nodes to the cluster.
      become: yes
      command: sh /tmp/kubernetes_join_command
      register: joined_or_not
